// Prisma Schema for Mykadoo Platform
// AI-powered gift search engine with affiliate integrations

generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// USER MANAGEMENT
// =============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  password      String? // Null for OAuth users
  name          String?
  avatar        String?
  role          UserRole  @default(FREE)
  status        UserStatus @default(ACTIVE)

  // OAuth providers
  accounts      Account[]

  // User preferences
  profile       UserProfile?

  // AI interactions
  conversations Conversation[]
  searches      Search[]

  // Wishlists and favorites
  wishlists     Wishlist[]
  favorites     Favorite[]

  // Recipient profiles
  recipientProfiles RecipientProfile[]

  // Subscription
  subscription  Subscription?

  // Feedback
  feedback      UserFeedback[]

  // Password reset tokens
  passwordResetTokens PasswordResetToken[]

  // Email verification tokens
  emailVerificationTokens EmailVerificationToken[]

  // Tracking
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  @@map("users")
}

enum UserRole {
  FREE
  GOLD
  PLATINUM
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String // oauth, email
  provider          String // google, facebook, email
  providerAccountId String  @map("provider_account_id")
  refreshToken      String? @map("refresh_token") @db.Text
  accessToken       String? @map("access_token") @db.Text
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token") @db.Text
  sessionState      String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal info
  phone         String?
  dateOfBirth   DateTime? @map("date_of_birth")
  gender        String?
  location      String?
  timezone      String?

  // Preferences
  currency              String   @default("USD")
  language              String   @default("en")
  preferredAIAgent      String?  @map("preferred_ai_agent") // Sophie, Max, Elena, Jordan
  notificationsEnabled  Boolean  @default(true) @map("notifications_enabled")
  emailNotifications    Boolean  @default(true) @map("email_notifications")

  // Gift preferences
  budgetMin     Float?   @map("budget_min")
  budgetMax     Float?   @map("budget_max")
  interests     String[] // Array of interest tags
  occasions     String[] // Birthdays, anniversaries, holidays, etc.

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_profiles")
}

// =============================================================================
// SUBSCRIPTION & BILLING
// =============================================================================

model Subscription {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan              SubscriptionPlan   @default(FREE)
  status            SubscriptionStatus @default(ACTIVE)
  billingInterval   BillingInterval    @default(MONTHLY) @map("billing_interval")
  currentPeriodStart DateTime?         @map("current_period_start")
  currentPeriodEnd   DateTime?         @map("current_period_end")
  cancelAtPeriodEnd  Boolean           @default(false) @map("cancel_at_period_end")
  canceledAt         DateTime?         @map("canceled_at")

  // Trial period
  trialStart        DateTime?          @map("trial_start")
  trialEnd          DateTime?          @map("trial_end")

  // Stripe/Payment provider
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")

  // Relations
  payments          Payment[]
  usageRecords      UsageRecord[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model Payment {
  id              String    @id @default(uuid())
  subscriptionId  String    @map("subscription_id")
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  stripePaymentIntentId String?  @unique @map("stripe_payment_intent_id")
  stripeInvoiceId       String?  @unique @map("stripe_invoice_id")

  amount          Int              // Amount in cents
  currency        String           @default("usd")
  status          PaymentStatus    @default(PENDING)

  description     String?
  invoiceUrl      String?          @map("invoice_url")
  receiptUrl      String?          @map("receipt_url")
  invoicePdf      String?          @map("invoice_pdf")

  paidAt          DateTime?        @map("paid_at")
  failedAt        DateTime?        @map("failed_at")
  refundedAt      DateTime?        @map("refunded_at")

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@index([subscriptionId])
  @@index([status])
  @@index([stripeInvoiceId])
  @@map("payments")
}

model UsageRecord {
  id              String       @id @default(uuid())
  subscriptionId  String       @map("subscription_id")
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  feature         UsageFeature
  count           Int          @default(0)
  limit           Int          // Maximum allowed for the period
  periodStart     DateTime     @map("period_start")
  periodEnd       DateTime     @map("period_end")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@unique([subscriptionId, feature, periodStart])
  @@index([subscriptionId, feature])
  @@index([periodStart, periodEnd])
  @@map("usage_records")
}

model PromoCode {
  id              String       @id @default(uuid())
  code            String       @unique

  discountType    DiscountType
  discountValue   Int          // Percentage (0-100) or cents for fixed amount

  // Validity
  validFrom       DateTime     @default(now()) @map("valid_from")
  validUntil      DateTime?    @map("valid_until")
  maxUses         Int?         @map("max_uses")
  currentUses     Int          @default(0) @map("current_uses")

  // Restrictions
  applicablePlans SubscriptionPlan[] @map("applicable_plans")
  minPlanRequired SubscriptionPlan?  @map("min_plan_required")

  // Trial extension
  trialDays       Int?         @map("trial_days")

  // Stripe coupon ID
  stripeCouponId  String?      @unique @map("stripe_coupon_id")

  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("promo_codes")
}

enum SubscriptionPlan {
  FREE
  GOLD
  PLATINUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
  PAUSED
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELED
}

enum UsageFeature {
  AI_SEARCH
  RECIPIENT_PROFILE
  WISHLIST
  WISHLIST_SHARE
  AI_CHAT
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// =============================================================================
// AI CONVERSATIONS & SEARCH
// =============================================================================

model Conversation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title     String? // Auto-generated summary
  agentType String   @map("agent_type") // Sophie, Max, Elena, Jordan
  context   Json? // Stored conversation context

  messages  Message[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role      MessageRole
  content   String      @db.Text
  metadata  Json? // Model used, cost, latency, etc.

  createdAt DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model Search {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id") // Nullable for anonymous searches
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  query         String
  filters       Json? // Budget, category, occasion, etc.
  results       SearchResult[]

  // AI model used
  model         String? // GPT-4, GPT-3.5, Claude Opus, etc.
  cost          Float? // Cost in USD
  latency       Int? // Response time in ms

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("searches")
}

model SearchResult {
  id        String   @id @default(uuid())
  searchId  String   @map("search_id")
  search    Search   @relation(fields: [searchId], references: [id], onDelete: Cascade)

  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id])

  rank      Int // Position in search results
  score     Float? // Relevance score

  createdAt DateTime @default(now()) @map("created_at")

  @@index([searchId])
  @@index([productId])
  @@map("search_results")
}

// =============================================================================
// PRODUCTS & AFFILIATE DATA
// =============================================================================

model Product {
  id          String   @id @default(uuid())

  // Product details
  title            String
  description      String?  @db.Text
  shortDescription String?  @map("short_description") @db.Text

  // Images
  imageUrl      String?  @map("image_url")
  galleryImages String[] @map("gallery_images") // Array of image URLs

  // Pricing
  price         Float
  salePrice     Float?   @map("sale_price") // If on sale, original price in 'price'
  currency      String   @default("USD")

  // Reviews & Ratings
  rating        Float?
  reviewCount   Int?     @map("review_count")

  // Affiliate info
  platform      AffiliatePlatform  // Amazon, ShareASale, CJ, Rakuten
  externalId    String   @map("external_id") // ASIN, SKU, merchant product ID
  affiliateLink String   @map("affiliate_link") @db.Text

  // Retailer info
  retailerName  String?  @map("retailer_name")
  retailerUrl   String?  @map("retailer_url") @db.Text
  brand         String?

  // Availability
  availability  ProductAvailability @default(UNKNOWN)

  // Categorization
  category    String?
  tags        String[]
  occasions   String[] // Birthday, anniversary, holiday, etc.
  ageGroups   String[] @map("age_groups") // Kids, teens, adults, seniors

  // Tracking
  clicks      Int      @default(0)
  conversions Int      @default(0)
  revenue     Float    @default(0) // Total affiliate revenue

  // Relations
  searchResults  SearchResult[]
  wishlistItems  WishlistItem[]
  favorites      Favorite[]

  // Metadata
  lastSyncedAt DateTime? @map("last_synced_at")
  isActive     Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([platform, externalId])
  @@index([category])
  @@index([platform])
  @@index([availability])
  @@index([price])
  @@index([rating])
  @@index([isActive])
  @@index([createdAt])
  @@map("products")
}

enum AffiliatePlatform {
  AMAZON
  SHAREASALE
  CJ
  RAKUTEN
  IMPACT
}

enum ProductAvailability {
  IN_STOCK
  OUT_OF_STOCK
  UNKNOWN
  DISCONTINUED
}

// =============================================================================
// RECIPIENT PROFILES
// =============================================================================

model RecipientProfile {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name          String
  relationship  String // Friend, Spouse, Parent, Sibling, etc.
  ageRange      String   @map("age_range") // Child, Teen, Young Adult, Adult, Senior
  gender        String?
  dateOfBirth   DateTime? @map("date_of_birth")

  // Preferences
  interests     String[] // Array of interest tags
  favoriteColors String[] @map("favorite_colors")
  hobbies       String[]
  dislikes      String[]

  // Occasions
  birthdayDate      DateTime? @map("birthday_date")
  anniversaryDate   DateTime? @map("anniversary_date")
  occasionReminders Json? @map("occasion_reminders") // Custom occasions with dates

  // Gift history
  giftHistory   Json[] @map("gift_history") // Track gifts given: {date, product, occasion, liked}

  // Notes
  notes         String?  @db.Text
  avatar        String? // URL to profile picture

  // Tracking
  lastGiftDate  DateTime? @map("last_gift_date")
  totalGiftsGiven Int @default(0) @map("total_gifts_given")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([name])
  @@map("recipient_profiles")
}

// =============================================================================
// WISHLISTS & FAVORITES
// =============================================================================

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isPublic    Boolean @default(false) @map("is_public")
  shareCode   String? @unique @map("share_code") // For public sharing

  items       WishlistItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([shareCode])
  @@map("wishlists")
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String   @map("wishlist_id")
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  productId  String   @map("product_id")
  product    Product  @relation(fields: [productId], references: [id])

  notes      String?
  priority   Int      @default(0) // For sorting
  isPurchased Boolean @default(false) @map("is_purchased")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_items")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

// =============================================================================
// USER FEEDBACK & LEARNING
// =============================================================================

model UserFeedback {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id") // Nullable for anonymous feedback
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  searchId  String   @map("search_id")
  productId String   @map("product_id")

  // Feedback type
  action    FeedbackAction
  rating    Int? // 1-5 stars

  // Context
  occasion       String?
  relationship   String?
  recipientAge   String? @map("recipient_age")
  searchContext  Json?   @map("search_context") // Original search parameters

  // Notes
  comment   String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([searchId])
  @@index([productId])
  @@index([action])
  @@index([createdAt])
  @@map("user_feedback")
}

enum FeedbackAction {
  VIEWED      // User clicked to view product
  SAVED       // Added to wishlist
  PURCHASED   // Marked as purchased
  DISMISSED   // Explicitly dismissed
  LIKED       // Positive reaction
  DISLIKED    // Negative reaction
  CLICKED     // Clicked affiliate link
}

model RecommendationImprovement {
  id        String   @id @default(uuid())

  // What was learned
  pattern   String   // e.g., "Users who like X also like Y"
  confidence Float   // 0-1 confidence score
  usageCount Int     @default(0) @map("usage_count") // How many times applied

  // Pattern details
  metadata  Json? // Store pattern parameters

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([confidence])
  @@index([usageCount])
  @@map("recommendation_improvements")
}

// =============================================================================
// ANALYTICS & TRACKING
// =============================================================================

model AffiliateLink {
  id        String   @id @default(uuid())

  productId String   @map("product_id")
  userId    String?  @map("user_id") // Nullable for anonymous users
  searchId  String?  @map("search_id") // Related search session

  url          String   @db.Text // Full affiliate URL
  trackingId   String   @map("tracking_id") // Internal tracking ID
  platform     AffiliatePlatform
  campaignId   String?  @map("campaign_id") // Optional campaign tracking

  clicks       AffiliateClick[]

  createdAt    DateTime @default(now()) @map("created_at")
  expiresAt    DateTime? @map("expires_at") // Optional expiry

  @@index([productId])
  @@index([userId])
  @@index([trackingId])
  @@index([platform])
  @@index([createdAt])
  @@map("affiliate_links")
}

model AffiliateClick {
  id        String   @id @default(uuid())

  linkId    String   @map("link_id") // Reference to AffiliateLink
  link      AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  productId String   @map("product_id")
  userId    String?  @map("user_id") // Nullable for anonymous clicks

  // Tracking
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent") @db.Text
  referer      String?

  // Conversion tracking
  converted    Boolean  @default(false)
  convertedAt  DateTime? @map("converted_at")
  orderValue   Float?   @map("order_value")
  commission   Float?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([linkId])
  @@index([productId])
  @@index([userId])
  @@index([converted])
  @@index([createdAt])
  @@map("affiliate_clicks")
}

model UserEvent {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id") // Nullable for anonymous events

  eventType String   @map("event_type") // page_view, search, click, etc.
  eventData Json?    @map("event_data")

  // Session tracking
  sessionId String?  @map("session_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@index([sessionId])
  @@index([createdAt])
  @@map("user_events")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique // SHA-256 hashed token
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false) // Mark as used after password reset

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique // SHA-256 hashed token
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false) // Mark as used after verification

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

// =============================================================================
// CONTENT MANAGEMENT SYSTEM (PRD 0004)
// =============================================================================

model Author {
  id        String   @id @default(uuid())

  // Author info
  name      String
  slug      String   @unique
  email     String?  @unique
  bio       String?  @db.Text
  avatarUrl String?  @map("avatar_url")

  // Social links
  twitterHandle  String?  @map("twitter_handle")
  linkedinUrl    String?  @map("linkedin_url")
  websiteUrl     String?  @map("website_url")

  // Relations
  articles  Article[]

  // Tracking
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isActive])
  @@map("authors")
}

model Category {
  id        String   @id @default(uuid())

  // Category info
  name        String
  slug        String   @unique
  description String?  @db.Text
  imageUrl    String?  @map("image_url")

  // Hierarchy (optional parent for nested categories)
  parentId    String?  @map("parent_id")
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  // Relations
  articles    ArticleCategory[]

  // SEO
  seoTitle       String?  @map("seo_title")
  seoDescription String?  @map("seo_description") @db.Text

  // Display order
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("categories")
}

model Tag {
  id        String   @id @default(uuid())

  // Tag info
  name      String   @unique
  slug      String   @unique

  // Relations
  articles  ArticleTag[]

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@map("tags")
}

model Article {
  id        String   @id @default(uuid())

  // Basic info
  title       String
  slug        String   @unique
  excerpt     String?  @db.Text // Short summary for previews
  content     String   @db.Text // HTML or Markdown content

  // Featured image
  featuredImageUrl    String?  @map("featured_image_url")
  featuredImageAlt    String?  @map("featured_image_alt")
  featuredImageCaption String? @map("featured_image_caption")

  // Author
  authorId    String   @map("author_id")
  author      Author   @relation(fields: [authorId], references: [id])

  // Status & scheduling
  status      ArticleStatus @default(DRAFT)
  publishedAt DateTime?     @map("published_at")
  scheduledAt DateTime?     @map("scheduled_at")

  // Content type
  contentType ArticleContentType @default(ARTICLE) @map("content_type")

  // SEO fields
  seoTitle       String?  @map("seo_title") // Override for title tag
  seoDescription String?  @map("seo_description") @db.Text // Meta description
  seoKeywords    String[] @map("seo_keywords")
  canonicalUrl   String?  @map("canonical_url") // For cross-posting

  // Open Graph
  ogTitle       String?  @map("og_title")
  ogDescription String?  @map("og_description") @db.Text
  ogImageUrl    String?  @map("og_image_url")

  // Reading metrics
  readingTimeMinutes Int?  @map("reading_time_minutes")
  wordCount          Int?  @map("word_count")

  // Analytics
  viewCount    Int      @default(0) @map("view_count")
  shareCount   Int      @default(0) @map("share_count")

  // Relations
  categories   ArticleCategory[]
  tags         ArticleTag[]
  relatedFrom  RelatedArticle[] @relation("RelatedFrom")
  relatedTo    RelatedArticle[] @relation("RelatedTo")
  media        ArticleMedia[]

  // Tracking
  isFeatured   Boolean  @default(false) @map("is_featured")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([contentType])
  @@index([authorId])
  @@index([isFeatured])
  @@index([viewCount])
  @@index([createdAt])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum ArticleContentType {
  ARTICLE       // Standard blog article
  GIFT_GUIDE    // Curated gift list
  HOW_TO        // Instructional content
  SEASONAL      // Holiday/occasion guides
  TREND         // Current trends
  BUYERS_GUIDE  // Category deep-dives
}

// Junction table for Article-Category many-to-many
model ArticleCategory {
  id         String   @id @default(uuid())
  articleId  String   @map("article_id")
  categoryId String   @map("category_id")

  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Primary category flag (one category can be primary)
  isPrimary  Boolean  @default(false) @map("is_primary")

  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([articleId, categoryId])
  @@index([articleId])
  @@index([categoryId])
  @@map("article_categories")
}

// Junction table for Article-Tag many-to-many
model ArticleTag {
  id        String   @id @default(uuid())
  articleId String   @map("article_id")
  tagId     String   @map("tag_id")

  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
  @@map("article_tags")
}

// Related articles for internal linking
model RelatedArticle {
  id            String   @id @default(uuid())
  articleId     String   @map("article_id")
  relatedId     String   @map("related_id")

  article       Article  @relation("RelatedFrom", fields: [articleId], references: [id], onDelete: Cascade)
  related       Article  @relation("RelatedTo", fields: [relatedId], references: [id], onDelete: Cascade)

  // Manual vs auto-generated
  isManual      Boolean  @default(false) @map("is_manual")
  relevanceScore Float?  @map("relevance_score") // For auto-generated relations

  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([articleId, relatedId])
  @@index([articleId])
  @@index([relatedId])
  @@map("related_articles")
}

// Media library for CMS
model Media {
  id        String   @id @default(uuid())

  // File info
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int      // Size in bytes

  // URLs
  url          String   @db.Text // Full CDN URL
  thumbnailUrl String?  @map("thumbnail_url") @db.Text

  // Responsive sizes (for images)
  sizes        Json?    // { "320": "url", "640": "url", "1024": "url", "1920": "url" }

  // Image dimensions (if applicable)
  width        Int?
  height       Int?

  // Metadata
  alt          String?  // Alt text for images
  caption      String?  @db.Text

  // Organization
  folder       String?  // Virtual folder path

  // Relations
  articles     ArticleMedia[]

  // Tracking
  uploadedBy   String?  @map("uploaded_by") // User ID who uploaded
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([mimeType])
  @@index([folder])
  @@index([createdAt])
  @@map("media")
}

// Junction table for Article-Media
model ArticleMedia {
  id        String   @id @default(uuid())
  articleId String   @map("article_id")
  mediaId   String   @map("media_id")

  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  // Usage context
  usage     String?  // "featured", "inline", "gallery"
  sortOrder Int      @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([articleId, mediaId])
  @@index([articleId])
  @@index([mediaId])
  @@map("article_media")
}
