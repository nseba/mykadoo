# Default values for Mykadoo Helm chart
# This is a YAML-formatted file.

# Global configuration
global:
  environment: production
  domain: mykadoo.com

# Replica counts for each service
replicaCount:
  web: 3
  api: 3

# Image configuration
image:
  registry: docker.io
  repository:
    web: mykadoo/web
    api: mykadoo/api
  tag: latest
  pullPolicy: IfNotPresent
  pullSecrets: []

# Service configuration
service:
  type: ClusterIP
  web:
    port: 80
    targetPort: 3000
    name: http
  api:
    port: 80
    targetPort: 3000
    name: http

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: mykadoo.com
      paths:
        - path: /
          pathType: Prefix
          service: web
    - host: api.mykadoo.com
      paths:
        - path: /
          pathType: Prefix
          service: api
  tls:
    - secretName: mykadoo-tls
      hosts:
        - mykadoo.com
        - api.mykadoo.com

# Resource limits and requests
resources:
  web:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  api:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# Autoscaling configuration
autoscaling:
  web:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  api:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# Health check configuration
healthCheck:
  web:
    liveness:
      path: /api/health
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /api/health
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
  api:
    liveness:
      path: /api/health
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /api/health
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

# Environment variables
env:
  NODE_ENV: production
  # Database connection will be set via ConfigMap/Secret
  # API URLs will be set via ConfigMap

# PostgreSQL configuration (Bitnami chart)
postgresql:
  enabled: true
  auth:
    username: mykadoo_user
    password: "" # Set via Secret in production
    database: mykadoo
  # Use pgvector-enabled PostgreSQL image
  image:
    registry: docker.io
    repository: pgvector/pgvector
    tag: pg16
  primary:
    # Enable pgvector extension on database initialization
    initdb:
      scripts:
        enable-pgvector.sql: |
          CREATE EXTENSION IF NOT EXISTS vector;
    persistence:
      enabled: true
      size: 20Gi
      storageClass: ""
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# pgvector configuration
pgvector:
  enabled: true
  # Embedding dimensions (OpenAI text-embedding-3-small uses 1536)
  dimensions: 1536
  # Index type: hnsw (faster, more memory) or ivfflat (efficient, less memory)
  indexType: hnsw
  # HNSW parameters
  hnsw:
    m: 16  # Number of connections per layer
    efConstruction: 64  # Search breadth during build
  # IVFFlat parameters
  ivfflat:
    lists: 100  # Number of clusters

# Redis configuration (Bitnami chart)
redis:
  enabled: true
  auth:
    password: "" # Set via Secret in production
  master:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: ""
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network policy
networkPolicy:
  enabled: false

# Service monitor for Prometheus
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s

# Backup configuration
backup:
  enabled: true
  timezone: "UTC"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  # Backup container image (includes pg_dump, aws-cli, openssl)
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent

  # Database backup settings
  database:
    # Daily backup at 2:00 AM UTC
    schedule: "0 2 * * *"
    type: full
    retentionDays: 30

  # Backup verification settings
  verification:
    # Weekly verification on Sunday at 3:00 AM UTC
    schedule: "0 3 * * 0"

  # S3 storage configuration
  s3:
    bucket: "mykadoo-backups"
    prefix: "database"
    region: "us-east-1"
    endpoint: ""  # For S3-compatible storage (MinIO, etc.)
    accessKeyId: ""  # Set via external secret
    secretAccessKey: ""  # Set via external secret

  # Encryption settings
  encryption:
    enabled: true
    key: ""  # Set via external secret

  # Notification settings
  notifications:
    slack:
      enabled: false
      webhookUrl: ""  # Set via external secret

  # Resource limits for backup jobs
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# Node selector, tolerations, and affinity
nodeSelector: {}
tolerations: []
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - mykadoo
          topologyKey: kubernetes.io/hostname
