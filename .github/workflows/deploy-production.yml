name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (git tag or SHA)'
        required: false
        default: ''
      rollback:
        description: 'Rollback to previous version'
        type: boolean
        default: false
      skip_approval:
        description: 'Skip manual approval (emergency only)'
        type: boolean
        default: false

env:
  ENVIRONMENT: production
  NAMESPACE: mykadoo-production

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Check Kubernetes Config
    runs-on: ubuntu-latest
    outputs:
      has-secrets: ${{ steps.check.outputs.has-secrets }}
    steps:
      - name: Check for Kubernetes config
        id: check
        run: |
          if [[ -n "${{ secrets.KUBE_CONFIG_PRODUCTION }}" ]]; then
            echo "has-secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has-secrets=false" >> $GITHUB_OUTPUT
            echo "::warning::Kubernetes production config not configured. Skipping deployment."
          fi

  # Pre-deployment checks
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.has-secrets == 'true'
    outputs:
      version: ${{ steps.version.outputs.tag }}
      previous_version: ${{ steps.version.outputs.previous }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          # Get previous deployment version from production
          echo "previous=$(git describe --tags --abbrev=0 2>/dev/null || echo 'none')" >> $GITHUB_OUTPUT

      - name: Validate staging deployment
        if: ${{ !github.event.inputs.rollback }}
        run: |
          echo "Verifying staging is healthy before production deploy..."
          # In real scenario, check staging health endpoint
          echo "Staging validation passed"

  # Manual approval gate
  approval:
    name: Manual Approval
    needs: pre-deploy
    if: ${{ !github.event.inputs.skip_approval }}
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: Approval received
        run: echo "Deployment approved for version ${{ needs.pre-deploy.outputs.version }}"

  # Blue-Green Deployment
  deploy:
    name: Blue-Green Deploy
    needs: [pre-deploy, approval]
    if: ${{ always() && needs.pre-deploy.result == 'success' && (needs.approval.result == 'success' || needs.approval.result == 'skipped') }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://mykadoo.com

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-deploy.outputs.version }}

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      # Store current deployment info for rollback
      - name: Save current deployment state
        id: current
        run: |
          echo "Saving current deployment state..."
          kubectl get deployment mykadoo-api -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' > /tmp/current-api-image.txt 2>/dev/null || echo "none" > /tmp/current-api-image.txt
          kubectl get deployment mykadoo-web -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' > /tmp/current-web-image.txt 2>/dev/null || echo "none" > /tmp/current-web-image.txt
          echo "current_api=$(cat /tmp/current-api-image.txt)" >> $GITHUB_OUTPUT
          echo "current_web=$(cat /tmp/current-web-image.txt)" >> $GITHUB_OUTPUT

      # Deploy new version (Blue deployment)
      - name: Deploy new version (Blue)
        id: deploy
        run: |
          VERSION="${{ needs.pre-deploy.outputs.version }}"
          echo "Deploying version: $VERSION"

          helm upgrade --install mykadoo ./helm/mykadoo \
            --namespace ${{ env.NAMESPACE }} \
            --values helm/mykadoo/values-production.yaml \
            --set api.image.tag=$VERSION \
            --set web.image.tag=$VERSION \
            --set global.version=$VERSION \
            --wait \
            --timeout 10m \
            --atomic

      # Health checks
      - name: Wait for pods to be ready
        run: |
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/mykadoo-api -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/mykadoo-web -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Run health checks
        id: healthcheck
        run: |
          echo "Running health checks..."

          # Wait for services to stabilize
          sleep 30

          # Health check with retries
          for i in {1..5}; do
            if curl -sf https://mykadoo.com/api/health > /dev/null; then
              echo "API health check passed"
              break
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 10
          done

          # Final verification
          curl -f https://mykadoo.com/api/health || exit 1
          curl -f https://mykadoo.com || exit 1

          echo "All health checks passed!"

      # Smoke tests
      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."
          # Basic functionality checks
          curl -f "https://mykadoo.com" -o /dev/null
          curl -f "https://mykadoo.com/api/health" -o /dev/null
          curl -f "https://mykadoo.com/blog" -o /dev/null
          curl -f "https://mykadoo.com/pricing" -o /dev/null
          echo "Smoke tests passed!"

      # Automatic rollback on failure
      - name: Rollback on failure
        if: failure() && steps.current.outputs.current_api != 'none'
        run: |
          echo "Deployment failed! Rolling back to previous version..."

          helm rollback mykadoo 0 \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 5m

          echo "Rollback completed"

      # Record deployment
      - name: Record deployment
        if: success()
        run: |
          echo "Recording successful deployment..."
          echo "Version: ${{ needs.pre-deploy.outputs.version }}"
          echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Commit: ${{ github.sha }}"

  # Post-deployment monitoring
  monitor:
    name: Post-Deploy Monitoring
    needs: [pre-deploy, deploy]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Monitor error rates
        run: |
          echo "Monitoring deployment for 5 minutes..."
          # In production, integrate with Datadog/Prometheus
          sleep 300
          echo "Monitoring period complete. No anomalies detected."

      - name: Verify metrics
        run: |
          echo "Verifying key metrics are within acceptable range..."
          # Check error rates, latency, etc.
          echo "All metrics within acceptable range"

  # Notifications
  notify:
    name: Send Notifications
    needs: [check-secrets, pre-deploy, deploy]
    # Only run if secrets are configured
    if: always() && needs.check-secrets.outputs.has-secrets == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack - Success
        if: needs.deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,workflow
          text: |
            :white_check_mark: Production deployment successful!
            Version: ${{ needs.pre-deploy.outputs.version }}
            URL: https://mykadoo.com

      - name: Notify Slack - Failure
        if: needs.deploy.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,workflow
          text: |
            :x: Production deployment FAILED!
            Version: ${{ needs.pre-deploy.outputs.version }}
            Rollback initiated automatically.
