name: PR Checks

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  CACHE_NAME: node-modules

jobs:
  # Dependency installation and caching
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.CACHE_NAME }}-

  # Lint check
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run ESLint (if configured)
        run: yarn nx run-many --target=lint --all --parallel=3 || echo "Lint targets not configured yet"
        continue-on-error: true

      - name: Check TypeScript
        run: yarn tsc --noEmit

  # Unit tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run unit tests (if configured)
        run: yarn nx run-many --target=test --all --parallel=3 --coverage || echo "Test targets not configured yet"
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/**/coverage-final.json
          flags: unittests
          name: unit-tests
        continue-on-error: true

  # Build applications
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        app: [web, api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build ${{ matrix.app }}
        run: yarn nx build ${{ matrix.app }} --prod

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.app }}
          path: dist/apps/${{ matrix.app }}
          retention-days: 7

  # E2E tests
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        app: [web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: yarn nx e2e ${{ matrix.app }}-e2e || echo "E2E tests not configured yet"
        continue-on-error: true

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.app }}
          path: |
            apps/${{ matrix.app }}-e2e/test-results/
            apps/${{ matrix.app }}-e2e/playwright-report/
          retention-days: 7
        continue-on-error: true

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Run npm audit
        run: yarn audit --groups dependencies || echo "Audit found issues (non-blocking)"
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  # Docker build test
  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        app: [web, api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.app }}/Dockerfile
          push: false
          tags: mykadoo/${{ matrix.app }}:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Check for required checks
  pr-checks-complete:
    name: All PR Checks Complete
    runs-on: ubuntu-latest
    needs: [lint, test-unit, build, test-e2e, security-audit, docker-build-test]
    if: always()
    steps:
      - name: Check job status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "‚ùå Lint failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          if [[ "${{ needs.docker-build-test.result }}" == "failure" ]]; then
            echo "‚ùå Docker build failed"
            exit 1
          fi
          echo "‚úÖ All required checks passed"

      - name: Comment PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            let message = '## ü§ñ PR Checks Summary\n\n';

            const jobStatus = {
              'lint': needs.lint.result,
              'test-unit': needs['test-unit'].result,
              'build': needs.build.result,
              'test-e2e': needs['test-e2e'].result,
              'security-audit': needs['security-audit'].result,
              'docker-build-test': needs['docker-build-test'].result
            };

            for (const [job, status] of Object.entries(jobStatus)) {
              const emoji = status === 'success' ? '‚úÖ' : status === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
              message += `${emoji} **${job}**: ${status}\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
